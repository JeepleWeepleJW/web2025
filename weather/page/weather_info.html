<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Weather Info</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <script defer src="../js/bootstrap.min.js"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const params     = new URLSearchParams(window.location.search);
            const code       = params.get('code');
            const modalEl    = document.getElementById('invalidModal');
            const modalTitle = modalEl.querySelector('.modal-title');
            const modalBody  = modalEl.querySelector('.modal-body');
            const closeBtn   = document.getElementById('closeBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const contentEl  = document.getElementById('content');
            const spinnerEl  = document.getElementById('loadingSpinner');

            function redirectToWeather() { window.location.href = 'weather.html'; }
            function showInvalidModal(){
                modalTitle.textContent = '잘못된 접근';
                modalBody.textContent  = '잘못된 접근입니다.';
                new bootstrap.Modal(modalEl).show();
                closeBtn.addEventListener('click', redirectToWeather);
                confirmBtn.addEventListener('click', redirectToWeather);
            }
            if(!code){ showInvalidModal(); return; }

            const skyMap = { '1':'맑음','3':'구름많음','4':'흐림' };

            // 스피너 표시
            spinnerEl.classList.remove('d-none');

            // 1) 주소 JSON 로드
            fetch('../data/weather_address.json')
                .then(r=>r.json())
                .then(data=>{
                    const select_address = data.find(item=>String(item.administrative_code)===code);
                    if(!select_address){ showInvalidModal(); throw 'no-address'; }

                    // 발표일시, 좌표 계산
                    const { base_date, base_time } = computeBaseDateTime();
                    const nx = Math.round(select_address.lat_decimal);
                    const ny = Math.round(select_address.lon_decimal);

                    // API 호출 URL 조립
                    const serviceKey = 'XBi6TBHmrnZ0J1zY7Xu4PpdsrKrOXjxRm8l7LSDxsdPpF0RMvZUVVhQF1nYQRQ87en0GXMRwD4y/XcPkr+BXAw==';
                    const apiUrl = new URL('https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst');
                    apiUrl.searchParams.append('serviceKey', serviceKey);
                    apiUrl.searchParams.append('numOfRows', 2000);
                    apiUrl.searchParams.append('pageNo', 1);
                    apiUrl.searchParams.append('dataType', 'JSON');
                    apiUrl.searchParams.append('base_date', base_date);
                    apiUrl.searchParams.append('base_time', base_time);
                    apiUrl.searchParams.append('nx', nx);
                    apiUrl.searchParams.append('ny', ny);

                    return fetch(apiUrl.toString());
                })
                .then(res=>{
                    if(!res.ok) throw 'api-error';
                    return res.json();
                })
                .then(json=>{
                    const items = json.response?.body?.items?.item || [];
                    if(!items.length){
                        contentEl.innerHTML = '<p class="text-center">단기예보 정보가 없습니다.</p>';
                        return;
                    }

                    // 2) 날짜별 그룹핑 & 카테고리별 최신 데이터만
                    const byDate = {};
                    items.forEach(e=>{
                        byDate[e.fcstDate] = byDate[e.fcstDate]||[];
                        byDate[e.fcstDate].push(e);
                    });
                    const latestByDate = {};
                    Object.keys(byDate).sort().forEach(date=>{
                        const latestThis = {};
                        byDate[date].forEach(e=>{
                            if(!latestThis[e.category] || e.fcstTime>latestThis[e.category].fcstTime){
                                latestThis[e.category]=e;
                            }
                        });
                        latestByDate[date] = latestThis;
                    });

                    // 오늘 날짜(컨텐츠1) / 그 외(컨텐츠2) 분리
                    const allDates = Object.keys(latestByDate).sort();
                    const todayDate = Object.keys(latestByDate)[0]; // 최우선 그룹을 오늘로 가정
                    const otherDates = allDates.filter(d=>d!==todayDate);

                    // helper: YYYYMMDD → "YYYY-MM-DD (요일)"
                    const formatDate = yyyymmdd=>{
                        const y=parseInt(yyyymmdd.slice(0,4)),
                            m=parseInt(yyyymmdd.slice(4,6))-1,
                            d=parseInt(yyyymmdd.slice(6,8));
                        const dt = new Date(y,m,d);
                        const days = ['일','월','화','수','목','금','토'];
                        return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')} (${days[dt.getDay()]}요일)`;
                    };

                    // ────────────────────────────────────────────
                    // 컨텐츠 1: 오늘 날씨
                    // ────────────────────────────────────────────
                    const block1 = document.createElement('div');
                    block1.className = 'text-center mb-5';
                    const h1 = document.createElement('h3');
                    h1.textContent = '오늘의 날씨';
                    block1.appendChild(h1);

                    const todayData = latestByDate[todayDate];
                    const tbl1 = document.createElement('table');
                    tbl1.className = 'table table-borderless w-auto mx-auto';
                    tbl1.innerHTML = `
          <tr><th>일시</th><td>${formatDate(todayDate)}</td></tr>
          <tr><th>하늘상태</th><td>${skyMap[todayData.SKY.fcstValue]||todayData.SKY.fcstValue}</td></tr>
          <tr><th>강수형태</th><td>${todayData.PTY.fcstValue}</td></tr>
          <tr><th>강수확률</th><td>${todayData.POP.fcstValue}%</td></tr>
          <tr><th>현재기온</th><td>${todayData.TMP.fcstValue}°C</td></tr>
        `;
                    block1.appendChild(tbl1);
                    contentEl.appendChild(block1);

                    // ────────────────────────────────────────────
                    // 컨텐츠 2: 다음 날씨 (그 외 날짜)
                    // ────────────────────────────────────────────
                    if(otherDates.length){
                        const block2 = document.createElement('div');
                        block2.className = 'text-center';
                        const h2 = document.createElement('h3');
                        h2.textContent = '앞으로의 날씨';
                        block2.appendChild(h2);

                        const row = document.createElement('div');
                        row.className = 'row justify-content-center';

                        otherDates.forEach(date=>{
                            const data = latestByDate[date];
                            const col = document.createElement('div');
                            col.className = 'col-10 col-md-3 mb-3';

                            const card = document.createElement('div');
                            card.className = 'card h-100';

                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body text-center';

                            cardBody.innerHTML = `
              <h5 class="card-title">${formatDate(date)}</h5>
              <p class="card-text mb-1">최저: ${data.TMN?.fcstValue||'-'}°C</p>
              <p class="card-text mb-1">최고: ${data.TMX?.fcstValue||'-'}°C</p>
              <p class="card-text">기온: ${data.TMP?.fcstValue||'-'}°C</p>
            `;
                            card.appendChild(cardBody);
                            col.appendChild(card);
                            row.appendChild(col);
                        });

                        block2.appendChild(row);
                        contentEl.appendChild(block2);
                    }
                })
                .catch(err=>{
                    if(err!=='no-address'){
                        contentEl.innerHTML = '<p class="text-center text-danger">API 호출 중 오류가 발생했습니다.</p>';
                    }
                })
                .finally(()=>{
                    spinnerEl.classList.add('d-none');
                });

            // helper: 발표일시 계산
            function computeBaseDateTime(){
                const now=new Date(),h=now.getHours(),m=now.getMinutes();
                const cand=[
                    {hh:23,mm:0,str:'2300'},
                    {hh:20,mm:0,str:'2000'},
                    {hh:17,mm:0,str:'1700'},
                    {hh:14,mm:0,str:'1400'},
                    {hh:11,mm:0,str:'1100'},
                    {hh: 8,mm:0,str:'0800'},
                    {hh: 5,mm:0,str:'0500'},
                    {hh: 2,mm:0,str:'0200'}
                ];
                for(let c of cand){
                    if(h>c.hh||(h===c.hh&&m>=10)){
                        const Y=now.getFullYear(),Mo=now.getMonth()+1,D=now.getDate();
                        return {
                            base_date:`${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}`,
                            base_time:c.str
                        };
                    }
                }
                const yst=new Date(now-86400000),
                    Y=yst.getFullYear(),Mo=yst.getMonth()+1,D=yst.getDate();
                return {
                    base_date:`${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}`,
                    base_time:'2300'
                };
            }
        });
    </script>
    <style>
        body {
            background-color:#fff;
            color:#000;
            font-family:Arial, sans-serif;
            padding-top:20px;
        }
    </style>
</head>
<body>
<!-- 로딩 스피너 -->
<div
        id="loadingSpinner"
        class="d-none position-fixed top-50 start-50 translate-middle
           d-flex justify-content-center align-items-center"
        style="z-index:1050;"
>
    <div class="spinner-border text-dark" role="status">
        <span class="visually-hidden">로딩중...</span>
    </div>
</div>

<div class="container" id="content"></div>

<!-- 잘못된 접근 모달 -->
<div class="modal fade" id="invalidModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeBtn">닫기</button>
                <button type="button" class="btn btn-secondary" id="confirmBtn">확인</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>