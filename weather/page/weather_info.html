<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Weather Info</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <script defer src="../js/bootstrap.min.js"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const params     = new URLSearchParams(window.location.search);
            const code       = params.get('code');
            const modalEl    = document.getElementById('invalidModal');
            const modalTitle = modalEl.querySelector('.modal-title');
            const modalBody  = modalEl.querySelector('.modal-body');
            const closeBtn   = document.getElementById('closeBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const contentEl  = document.getElementById('content');
            const spinnerEl  = document.getElementById('loadingSpinner');

            function redirectToWeather() { window.location.href = 'weather.html'; }
            function showInvalidModal(){
                modalTitle.textContent = '잘못된 접근';
                modalBody.textContent  = '잘못된 접근입니다.';
                new bootstrap.Modal(modalEl).show();
                closeBtn.addEventListener('click', redirectToWeather);
                confirmBtn.addEventListener('click', redirectToWeather);
            }
            if (!code) { showInvalidModal(); return; }

            const skyMap = { '1':'맑음','3':'구름많음','4':'흐림' };
            const ICON_SUNNY = '../img/ic_weather_sunny.png';
            const ICON_CLOUD = '../img/ic_weather_cloud.png';
            const ICON_RAIN  = '../img/ic_weather_rain.png';
            const ICON_SNOW  = '../img/ic_weather_snow.png';

            function getWeatherIcon(entry){
                const pty = entry.PTY?.fcstValue;
                const pop = parseInt(entry.POP?.fcstValue,10) || 0;
                const sky = entry.SKY?.fcstValue;
                if ([ '1','2','4' ].includes(String(pty))) return ICON_RAIN;
                if (String(pty) === '3') return ICON_SNOW;
                if (pop >= 50) return ICON_RAIN;
                if (String(sky) === '1') return ICON_SUNNY;
                if ([ '3','4' ].includes(String(sky))) return ICON_CLOUD;
                return ICON_CLOUD;
            }

            // 주소명 미리 가져오기
            let addressName = '';
            fetch('../data/weather_keyword.json')
                .then(r => r.json())
                .then(data => {
                    const kw = data.find(item => String(item.administrative_code) === code);
                    if (!kw) { showInvalidModal(); throw 'no-address-kw'; }
                    addressName = kw.address;
                });

            spinnerEl.classList.remove('d-none');

            fetch('../data/weather_address.json')
                .then(r=>r.json())
                .then(data=>{
                    const select_address = data.find(item=>String(item.administrative_code) === code);
                    if (!select_address) { showInvalidModal(); throw 'no-address'; }
                    const { base_date, base_time } = computeBaseDateTime();
                    const nx = Math.round(select_address.lat_decimal);
                    const ny = Math.round(select_address.lon_decimal);

                    const serviceKey = 'XBi6TBHmrnZ0J1zY7Xu4PpdsrKrOXjxRm8l7LSDxsdPpF0RMvZUVVhQF1nYQRQ87en0GXMRwD4y/XcPkr+BXAw==';
                    const apiUrl = new URL('https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst');
                    apiUrl.searchParams.append('serviceKey', serviceKey);
                    apiUrl.searchParams.append('numOfRows', 2000);
                    apiUrl.searchParams.append('pageNo', 1);
                    apiUrl.searchParams.append('dataType', 'JSON');
                    apiUrl.searchParams.append('base_date', base_date);
                    apiUrl.searchParams.append('base_time', base_time);
                    apiUrl.searchParams.append('nx', nx);
                    apiUrl.searchParams.append('ny', ny);

                    return fetch(apiUrl.toString());
                })
                .then(res=>{ if(!res.ok) throw 'api-error'; return res.json(); })
                .then(json=>{
                    const items = json.response?.body?.items?.item || [];
                    if (!items.length){
                        contentEl.innerHTML = '<p class="text-center">단기예보 정보가 없습니다.</p>';
                        return;
                    }
                    // 그룹핑 & 최신값 선택
                    const byDate = {};
                    items.forEach(e=>{
                        (byDate[e.fcstDate] = byDate[e.fcstDate]||[]).push(e);
                    });
                    const latestByDate = {};
                    Object.keys(byDate).sort().forEach(date=>{
                        const latestThis = {};
                        byDate[date].forEach(e=>{
                            if (!latestThis[e.category] || e.fcstTime > latestThis[e.category].fcstTime){
                                latestThis[e.category] = e;
                            }
                        });
                        latestByDate[date] = latestThis;
                    });
                    const allDates   = Object.keys(latestByDate).sort();
                    const todayDate  = allDates[0];
                    const otherDates = allDates.slice(1);

                    function formatDateYM(yyyymmdd){
                        const y = +yyyymmdd.slice(0,4),
                            m = +yyyymmdd.slice(4,6)-1,
                            d = +yyyymmdd.slice(6,8),
                            dt= new Date(y,m,d),
                            days=['일','월','화','수','목','금','토'];
                        return `${days[dt.getDay()]} (${String(m+1).padStart(2,'0')}.${String(d).padStart(2,'0')})`;
                    }

                    // ───── 오늘의 날씨 ─────
                    const today = latestByDate[todayDate];
                    const block1 = document.createElement('div');
                    block1.className = 'd-flex align-items-center mb-5';
                    block1.innerHTML = `
            <img src="${getWeatherIcon(today)}" alt="" style="width:64px; margin-right:12px;">
            <div>
              <h3>${addressName}</h3>
              <div><strong>${formatDateYM(todayDate)}</strong></div>
              <div class="small text-muted">${skyMap[today.SKY.fcstValue]||''} · 어제보다 ${ (today.TMP.fcstValue - (today.TMP.fcstValue||0)).toFixed(1) }°</div>
              <table class="table table-borderless w-auto mt-2 mb-0">
                <tr><th>체감</th><td>${today.TMP.fcstValue}°C</td></tr>
                <tr><th>습도</th><td>${today.REH?.fcstValue||''}%</td></tr>
                <tr><th>풍속</th><td>${today.WSD?.fcstValue||''}m/s</td></tr>
              </table>
            </div>
          `;
                    contentEl.appendChild(block1);

                    // ───── 주간 예보 ─────
                    if (otherDates.length){
                        const weekly = document.createElement('div');
                        weekly.innerHTML = '<h3 class="mb-3">주간 예보</h3>';
                        const row = document.createElement('div');
                        row.className = 'row';
                        // 2열로 분할
                        const mid = Math.ceil(otherDates.length/2);
                        [ otherDates.slice(0,mid), otherDates.slice(mid) ].forEach(colDates => {
                            const col = document.createElement('div');
                            col.className = 'col-6';
                            colDates.forEach(date => {
                                const d = latestByDate[date];
                                const line = document.createElement('div');
                                line.className = 'd-flex align-items-center justify-content-between py-2 border-bottom';
                                line.innerHTML = `
                  <div>${formatDateYM(date)}</div>
                  <div class="text-center">
                    <small>오전</small><br>
                    <img src="${getWeatherIcon(d)}" style="width:24px;"><br>
                    <small>${d.POP.fcstValue}%</small>
                  </div>
                  <div class="text-center">
                    <small>오후</small><br>
                    <img src="${getWeatherIcon(d)}" style="width:24px;"><br>
                    <small>${d.POP.fcstValue}%</small>
                  </div>
                  <div>
                    <span class="text-primary">${d.TMN?.fcstValue||d.TMP.fcstValue}°</span>
                    <span class="text-danger ms-1">${d.TMX?.fcstValue||d.TMP.fcstValue}°</span>
                  </div>
                `;
                                col.appendChild(line);
                            });
                            row.appendChild(col);
                        });
                        weekly.appendChild(row);
                        contentEl.appendChild(weekly);
                    }
                })
                .catch(err=>{
                    if (err!=='no-address'){
                        contentEl.innerHTML = '<p class="text-center text-danger">API 호출 중 오류가 발생했습니다.</p>';
                    }
                })
                .finally(()=>{
                    spinnerEl.classList.add('d-none');
                });

            function computeBaseDateTime(){
                const now=new Date(),h=now.getHours(),m=now.getMinutes();
                const cand=[
                    {hh:23,mm:0,str:'2300'},
                    {hh:20,mm:0,str:'2000'},
                    {hh:17,mm:0,str:'1700'},
                    {hh:14,mm:0,str:'1400'},
                    {hh:11,mm:0,str:'1100'},
                    {hh: 8,mm:0,str:'0800'},
                    {hh: 5,mm:0,str:'0500'},
                    {hh: 2,mm:0,str:'0200'}
                ];
                for(let c of cand){
                    if(h>c.hh||(h===c.hh&&m>=10)){
                        const Y=now.getFullYear(),Mo=now.getMonth()+1,D=now.getDate();
                        return { base_date:`${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}`, base_time:c.str };
                    }
                }
                const yst=new Date(now-86400000),
                    Y=yst.getFullYear(),Mo=yst.getMonth()+1,D=yst.getDate();
                return { base_date:`${Y}${String(Mo).padStart(2,'0')}${String(D).padStart(2,'0')}`, base_time:'2300' };
            }
        });
    </script>
    <style>
        body {
            background-color:#fff;
            color:#000;
            font-family:Arial,sans-serif;
            padding-top:20px;
        }
        .border-bottom { border-color: #dee2e6 !important; }
    </style>
</head>
<body>
<!-- 로딩 스피너 -->
<div id="loadingSpinner"
     class="d-none position-fixed top-50 start-50 translate-middle
              d-flex justify-content-center align-items-center"
     style="z-index:1050;">
    <div class="spinner-border text-dark" role="status">
        <span class="visually-hidden">로딩중...</span>
    </div>
</div>

<div class="container" id="content"></div>

<!-- 잘못된 접근 모달 -->
<div class="modal fade" id="invalidModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeBtn">닫기</button>
                <button type="button" class="btn btn-secondary" id="confirmBtn">확인</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>